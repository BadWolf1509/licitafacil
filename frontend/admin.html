<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LicitaF치cil - Painel Admin</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            text-align: center;
            padding: var(--spacing-lg);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border);
        }

        .user-card:last-child {
            border-bottom: none;
        }

        .user-info h4 {
            margin-bottom: var(--spacing-xs);
        }

        .user-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-lg);
        }

        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="dashboard.html" class="header-logo">LicitaF치cil</a>
        <nav class="header-nav">
            <a href="dashboard.html">Dashboard</a>
            <a href="atestados.html">Atestados</a>
            <a href="analises.html">An치lises</a>
            <a href="admin.html" id="adminLink" class="active">Admin</a>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">游깹</button>
            <button class="btn btn-outline btn-sm" onclick="logout()">Sair</button>
        </nav>
    </header>

    <div class="container">
        <div id="alertContainer"></div>

        <h1 class="mb-3">Painel Administrativo</h1>

        <!-- Estat칤sticas -->
        <div class="stats-grid">
            <div class="card stat-card">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">Total de Usu치rios</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="statAprovados">0</div>
                <div class="stat-label">Aprovados</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="statPendentes">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="statInativos">0</div>
                <div class="stat-label">Inativos</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="pendentes">Pendentes</button>
                <button class="tab" data-tab="todos">Todos os Usu치rios</button>
            </div>

            <!-- Tab Pendentes -->
            <div id="tab-pendentes" class="tab-content active">
                <div id="listaPendentes">
                    <div class="empty-state">Carregando...</div>
                </div>
            </div>

            <!-- Tab Todos -->
            <div id="tab-todos" class="tab-content">
                <div id="listaTodos">
                    <div class="empty-state">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            verificarAdmin();
            setupTabs();
            carregarEstatisticas();
            carregarUsuariosPendentes();
            carregarTodosUsuarios();
        });

        async function verificarAdmin() {
            try {
                const status = await api.get('/auth/status');
                if (!status.admin) {
                    ui.showAlert('Acesso restrito a administradores', 'error');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                }
            } catch (error) {
                window.location.href = 'index.html';
            }
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;

                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    contents.forEach(c => {
                        c.classList.remove('active');
                        if (c.id === `tab-${targetTab}`) {
                            c.classList.add('active');
                        }
                    });
                });
            });
        }

        async function carregarEstatisticas() {
            try {
                const stats = await api.get('/admin/estatisticas');
                document.getElementById('statTotal').textContent = stats.total_usuarios;
                document.getElementById('statAprovados').textContent = stats.usuarios_aprovados;
                document.getElementById('statPendentes').textContent = stats.usuarios_pendentes;
                document.getElementById('statInativos').textContent = stats.usuarios_inativos;
            } catch (error) {
                console.error('Erro ao carregar estat칤sticas:', error);
            }
        }

        async function carregarUsuariosPendentes() {
            try {
                const usuarios = await api.get('/admin/usuarios/pendentes');
                const container = document.getElementById('listaPendentes');

                if (usuarios.length === 0) {
                    container.innerHTML = '<div class="empty-state">Nenhum usu치rio pendente de aprova칞칚o.</div>';
                    return;
                }

                container.innerHTML = usuarios.map(u => `
                    <div class="user-card">
                        <div class="user-info">
                            <h4>${u.nome}</h4>
                            <p class="text-muted">${u.email}</p>
                            <small class="text-muted">Cadastrado em: ${formatarData(u.created_at)}</small>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-success btn-sm" onclick="aprovarUsuario(${u.id})">Aprovar</button>
                            <button class="btn btn-danger btn-sm" onclick="rejeitarUsuario(${u.id})">Rejeitar</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                ui.showAlert('Erro ao carregar usu치rios pendentes', 'error');
            }
        }

        async function carregarTodosUsuarios() {
            try {
                const usuarios = await api.get('/admin/usuarios');
                const container = document.getElementById('listaTodos');

                if (usuarios.length === 0) {
                    container.innerHTML = '<div class="empty-state">Nenhum usu치rio cadastrado.</div>';
                    return;
                }

                container.innerHTML = usuarios.map(u => {
                    let statusBadge = '';
                    if (!u.is_active) {
                        statusBadge = '<span class="badge badge-error">Inativo</span>';
                    } else if (!u.is_approved) {
                        statusBadge = '<span class="badge badge-warning">Pendente</span>';
                    } else if (u.is_admin) {
                        statusBadge = '<span class="badge badge-info">Admin</span>';
                    } else {
                        statusBadge = '<span class="badge badge-success">Ativo</span>';
                    }

                    let actions = '';
                    if (!u.is_admin) {
                        if (!u.is_approved && u.is_active) {
                            actions = `
                                <button class="btn btn-success btn-sm" onclick="aprovarUsuario(${u.id})">Aprovar</button>
                                <button class="btn btn-danger btn-sm" onclick="rejeitarUsuario(${u.id})">Rejeitar</button>
                            `;
                        } else if (!u.is_active) {
                            actions = `<button class="btn btn-outline btn-sm" onclick="reativarUsuario(${u.id})">Reativar</button>`;
                        } else {
                            actions = `<button class="btn btn-danger btn-sm" onclick="rejeitarUsuario(${u.id})">Desativar</button>`;
                        }
                    }

                    return `
                        <div class="user-card">
                            <div class="user-info">
                                <h4>${u.nome} ${statusBadge}</h4>
                                <p class="text-muted">${u.email}</p>
                                <small class="text-muted">Cadastrado em: ${formatarData(u.created_at)}</small>
                            </div>
                            <div class="user-actions">
                                ${actions}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                ui.showAlert('Erro ao carregar usu치rios', 'error');
            }
        }

        async function aprovarUsuario(id) {
            try {
                await api.post(`/admin/usuarios/${id}/aprovar`);
                ui.showAlert('Usu치rio aprovado com sucesso!', 'success');
                carregarEstatisticas();
                carregarUsuariosPendentes();
                carregarTodosUsuarios();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao aprovar usu치rio', 'error');
            }
        }

        async function rejeitarUsuario(id) {
            if (!confirm('Tem certeza que deseja desativar este usu치rio?')) return;

            try {
                await api.post(`/admin/usuarios/${id}/rejeitar`);
                ui.showAlert('Usu치rio desativado com sucesso!', 'success');
                carregarEstatisticas();
                carregarUsuariosPendentes();
                carregarTodosUsuarios();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao desativar usu치rio', 'error');
            }
        }

        async function reativarUsuario(id) {
            try {
                await api.post(`/admin/usuarios/${id}/reativar`);
                ui.showAlert('Usu치rio reativado com sucesso!', 'success');
                carregarEstatisticas();
                carregarTodosUsuarios();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao reativar usu치rio', 'error');
            }
        }
    </script>
</body>
</html>
