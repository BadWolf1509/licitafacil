<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LicitaF√°cil - Atestados</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: var(--spacing-lg);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-zone input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .atestado-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--spacing-lg);
        }

        .atestado-info {
            flex: 1;
        }

        .atestado-quantidade {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .atestado-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .processing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .processing-header-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .processing-header-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .processing-job {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            margin-bottom: var(--spacing-sm);
            flex-wrap: wrap;
            border-left: 4px solid transparent;
        }

        .processing-job:last-child {
            margin-bottom: 0;
        }

        .processing-job.pending {
            border-left-color: var(--warning);
        }

        .processing-job.processing {
            border-left-color: var(--info);
        }

        .processing-job.failed {
            border-left-color: var(--error);
            background: var(--error-bg);
        }

        .processing-job.cancelled {
            border-left-color: var(--border);
            background: var(--bg-secondary);
        }

        .processing-job-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .processing-job-title {
            font-weight: 600;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .processing-job-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs) var(--spacing-md);
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .job-meta-item {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .processing-job-info {
            flex: 1;
            min-width: 220px;
        }

        .processing-job-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-left: auto;
        }

        .processing-job-error {
            margin-top: var(--spacing-xs);
            color: var(--error);
            font-size: 0.85rem;
        }

        .job-status {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .job-status.pending {
            border-color: var(--warning);
            color: #92400E;
            background: var(--warning-bg);
        }

        .job-status.processing {
            border-color: var(--info);
            color: #1E40AF;
            background: var(--info-bg);
        }

        .job-status.failed {
            border-color: var(--error);
            color: #991B1B;
            background: var(--error-bg);
        }

        .job-status.cancelled {
            border-color: var(--border);
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }

        .processing-progress {
            height: 6px;
            background: var(--border);
            border-radius: 999px;
            overflow: hidden;
            margin-top: var(--spacing-xs);
        }

        .processing-progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary), var(--primary-hover));
            transition: width 0.2s ease;
        }

        .processing-progress.pending .processing-progress-bar {
            background: linear-gradient(90deg, var(--warning), #fcd34d);
        }

        .processing-progress.indeterminate .processing-progress-bar {
            width: 40%;
            animation: progress-indeterminate 1.2s ease-in-out infinite;
        }

        @keyframes progress-indeterminate {
            0% { transform: translateX(-120%); }
            50% { transform: translateX(20%); }
            100% { transform: translateX(180%); }
        }

        .atestado-highlight {
            border-color: var(--success);
            box-shadow: 0 0 0 3px var(--success-bg);
            animation: highlight-fade 2s ease-out;
        }

        @keyframes highlight-fade {
            0% { box-shadow: 0 0 0 6px var(--success-bg); }
            100% { box-shadow: 0 0 0 0 transparent; }
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }

        /* Estilos para servi√ßos detalhados */
        .servicos-toggle {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: var(--spacing-xs) 0;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .servicos-toggle:hover {
            text-decoration: underline;
        }

        .servicos-toggle .chevron {
            display: inline-block;
            transition: transform 0.2s ease;
            font-size: 0.75rem;
        }

        .servicos-lista {
            display: none;
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .servicos-lista.active {
            display: block;
        }

        .servico-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border);
            gap: var(--spacing-md);
        }

        .servico-item:last-child {
            border-bottom: none;
        }

        .servico-descricao {
            flex: 1;
            font-family: monospace;
        }

        .servico-item-codigo {
            display: inline-block;
            margin-right: var(--spacing-sm);
            padding: 1px 6px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-primary);
        }

        .servico-quantidade {
            font-family: monospace;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .servico-actions {
            display: flex;
            gap: 2px;
            margin-left: var(--spacing-sm);
        }

        .servico-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            opacity: 0.4;
            padding: 2px 6px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .servico-btn:hover {
            opacity: 1;
        }

        .servico-btn.edit:hover {
            color: var(--primary);
        }

        .servico-btn.delete:hover {
            color: var(--error);
        }

        .servico-item:hover .servico-btn {
            opacity: 0.7;
        }

        /* Modal de edi√ß√£o de servi√ßo */
        .modal-sm {
            max-width: 450px;
        }

        /* Modal de relat√≥rio */
        .modal-lg {
            max-width: 800px;
        }

        .modal-xl {
            max-width: 1000px;
        }

        /* Relat√≥rio */
        .relatorio-header {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .relatorio-header h3 {
            margin-bottom: var(--spacing-sm);
            color: var(--primary);
        }

        .relatorio-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .relatorio-info-item {
            display: flex;
            flex-direction: column;
        }

        .relatorio-info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }

        .relatorio-info-value {
            font-weight: 600;
        }

        .relatorio-section {
            margin-bottom: var(--spacing-lg);
        }

        .relatorio-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary);
        }

        .relatorio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .relatorio-table th,
        .relatorio-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .relatorio-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .relatorio-table td.numero {
            text-align: right;
            font-family: monospace;
            white-space: nowrap;
        }

        .relatorio-table tr:hover {
            background: var(--bg-secondary);
        }

        /* Badge de contagem */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
        }

        .badge-secondary {
            background: var(--text-secondary);
        }

        /* Toolbar de a√ß√µes globais */
        .toolbar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        /* Atestado card no relat√≥rio global */
        .relatorio-atestado {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .relatorio-atestado-header {
            background: var(--bg-secondary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .relatorio-atestado-body {
            padding: var(--spacing-lg);
        }

        .relatorio-atestado-numero {
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="dashboard.html" class="header-logo">LicitaF√°cil</a>
        <nav class="header-nav">
            <a href="dashboard.html">Dashboard</a>
            <a href="atestados.html" class="active">Atestados</a>
            <a href="analises.html">An√°lises</a>
            <a href="admin.html" id="adminLink" class="hidden">Admin</a>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">&#127763;</button>
            <button class="btn btn-outline btn-sm" onclick="logout()">Sair</button>
        </nav>
    </header>

    <div class="container">
        <div id="alertContainer"></div>

        <div id="processingJobs" class="mb-2"></div>

        <div class="d-flex justify-between align-center mb-3">
            <h1>Meus Atestados</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline" onclick="abrirRelatorioGeral()" id="btnRelatorioGeral" style="display: none;">
                    Relatorio Geral
                </button>
                <button class="btn btn-primary" onclick="abrirModalAtestado()">+ Novo Atestado</button>
            </div>
        </div>

        <!-- Upload de arquivo -->
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">&#128196;</div>
            <h3>Arraste um PDF ou imagem aqui</h3>
            <p class="text-muted">ou clique para selecionar um arquivo</p>
            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg">
        </div>

        <!-- Lista de atestados -->
        <div id="listaAtestados">
            <div class="card empty-state">
                <div class="empty-state-icon">&#128203;</div>
                <h3>Carregando atestados...</h3>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado Consolidado (Individual) -->
    <div class="modal" id="modalResultado">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Resultado Consolidado</h2>
                <button class="modal-close" onclick="fecharModal('modalResultado')">&times;</button>
            </div>
            <div id="resultadoContent">
                Carregando...
            </div>
        </div>
    </div>

    <!-- Modal de Relat√≥rio Geral (Todos os Atestados) -->
    <div class="modal" id="modalRelatorioGeral">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2>Relatorio Consolidado - Todos os Atestados</h2>
                <button class="modal-close" onclick="fecharModal('modalRelatorioGeral')">&times;</button>
            </div>
            <div id="relatorioGeralContent">
                Carregando...
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro/Edi√ß√£o de Atestado -->
    <div class="modal" id="modalAtestado">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalAtestadoTitle">Cadastrar Atestado</h2>
                <button class="modal-close" onclick="fecharModal('modalAtestado')">&times;</button>
            </div>
            <form id="formAtestado">
                <input type="hidden" id="atId">
                <div class="form-group">
                    <label class="form-label">Descricao do Servico *</label>
                    <input type="text" class="form-input" id="atDescricao" required
                        placeholder="Ex: Execucao de pavimentacao asfaltica">
                </div>
                <div class="d-flex gap-2">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">Quantidade *</label>
                        <input type="number" class="form-input" id="atQuantidade" step="0.01" required
                            placeholder="1000">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Unidade *</label>
                        <input type="text" class="form-input" id="atUnidade" required
                            placeholder="m2, m3, un...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Contratante</label>
                    <input type="text" class="form-input" id="atContratante"
                        placeholder="Nome do orgao/empresa contratante">
                </div>
                <div class="form-group">
                    <label class="form-label">Data de Emissao</label>
                    <input type="date" class="form-input" id="atDataEmissao">
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                    <button type="button" class="btn btn-outline" onclick="fecharModal('modalAtestado')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Item de Servi√ßo -->
    <div class="modal" id="modalEditarServico">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>Editar Item de Servico</h2>
                <button class="modal-close" onclick="fecharModal('modalEditarServico')">&times;</button>
            </div>
            <form id="formEditarServico" onsubmit="salvarServicoItem(event)">
                <input type="hidden" id="editServicoAtestadoId">
                <input type="hidden" id="editServicoIndex">
                <div class="form-group">
                    <label class="form-label">Item (codigo)</label>
                    <input type="text" class="form-input" id="editServicoItem"
                        placeholder="Ex: 001.03.11">
                </div>
                <div class="form-group">
                    <label class="form-label">Descricao *</label>
                    <input type="text" class="form-input" id="editServicoDescricao" required
                        placeholder="Ex: Execucao de pavimentacao asfaltica">
                </div>
                <div class="d-flex gap-2">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">Quantidade *</label>
                        <input type="number" class="form-input" id="editServicoQuantidade" step="0.01" required
                            placeholder="1000">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Unidade *</label>
                        <input type="text" class="form-input" id="editServicoUnidade" required
                            placeholder="m2, m3...">
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                    <button type="button" class="btn btn-outline" onclick="fecharModal('modalEditarServico')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Cache de atestados para relat√≥rio geral
        let atestadosCache = [];

        document.addEventListener('DOMContentLoaded', () => {
            carregarAtestados();
            carregarJobsEmProcessamento();
            setupUpload();
            setupFormAtestado();
            startJobsRefresh();
            startJobsRenderer();
        });

        const jobsEmProcessamento = new Map();
        const jobTimers = new Map();
        const notifiedJobs = new Set();
        const recentlyCompletedPaths = new Set();
        let refreshJobsInterval = null;
        let jobsRenderInterval = null;

        function formatarTempo(ms) {
            const total = Math.max(0, Math.floor(ms / 1000));
            const min = Math.floor(total / 60);
            const sec = total % 60;
            return `${min}m ${sec.toString().padStart(2, '0')}s`;
        }

        function parseJobTime(value) {
            if (!value) return null;
            const time = Date.parse(value);
            return Number.isNaN(time) ? null : time;
        }

        function getJobTimes(job) {
            const createdAt = parseJobTime(job.created_at);
            const localCreatedAt = parseJobTime(job.local_created_at);
            let startedAt = parseJobTime(job.started_at);
            const endedAt = parseJobTime(job.completed_at || job.canceled_at);
            const now = Date.now();

            let effectiveCreatedAt = createdAt;
            if (!effectiveCreatedAt || effectiveCreatedAt > now + 2000) {
                effectiveCreatedAt = localCreatedAt;
            }
            if (!effectiveCreatedAt && startedAt) {
                effectiveCreatedAt = startedAt;
            }

            if (!effectiveCreatedAt) {
                return { queueMs: 0, processingMs: 0, hasQueue: false, hasProcessing: false };
            }

            const displayStatus = getDisplayStatus(job);
            if (!startedAt && displayStatus === 'processing') {
                startedAt = effectiveCreatedAt || now;
            }

            if (!startedAt) {
                return {
                    queueMs: Math.max(0, now - effectiveCreatedAt),
                    processingMs: 0,
                    hasQueue: true,
                    hasProcessing: false
                };
            }

            if (effectiveCreatedAt > startedAt) {
                effectiveCreatedAt = startedAt;
            }
            const queueMs = Math.max(0, startedAt - effectiveCreatedAt);
            const processingMs = Math.max(0, (endedAt || now) - startedAt);
            return {
                queueMs,
                processingMs,
                hasQueue: true,
                hasProcessing: true
            };
        }

        function getJobStatusLabel(status) {
            const labels = {
                pending: 'Na fila',
                processing: 'Processando',
                failed: 'Falhou',
                cancelled: 'Cancelado',
                completed: 'Concluido'
            };
            return labels[status] || 'Processando';
        }

        // Mapeia stage para tipo de pipeline
        function getPipelineFromStage(stage) {
            const stagePipeline = {
                'queued': null,
                'pending': null,
                'processing': null,
                'texto': 'NATIVE_TEXT',
                'ocr': 'LOCAL_OCR',
                'vision': 'VISION_AI',
                'ia': null, // An√°lise IA (comum a todos)
                'final': null,
                'merge': null,
                'save': null
            };
            return stagePipeline[stage] || null;
        }

        // Label amig√°vel do pipeline
        function getPipelineLabel(pipeline) {
            const labels = {
                'NATIVE_TEXT': 'Extra√ß√£o Nativa',
                'LOCAL_OCR': 'OCR Local',
                'CLOUD_OCR': 'OCR Cloud (Azure)',
                'VISION_AI': 'GPT-4o Vision'
            };
            return labels[pipeline] || pipeline;
        }

        function normalizeJobStage(stage, status) {
            const normalized = (stage || '').toString().toLowerCase();
            if (!normalized || normalized === 'pending' || normalized === 'queued') {
                return status === 'pending' ? 'queued' : 'processing';
            }
            if (normalized === 'finalizar' || normalized === 'finalizando') {
                return 'final';
            }
            return normalized;
        }

        function getDisplayStatus(job) {
            const raw = (job?.status || '').toString().toLowerCase();
            if (raw === 'failed' || raw === 'cancelled' || raw === 'completed') {
                return raw;
            }
            const stage = normalizeJobStage(job?.progress_stage, raw);
            const hasStarted = Boolean(job?.started_at);
            const hasProgress = Number(job?.progress_current) > 0 || Number(job?.progress_total) > 0;
            if (raw === 'pending' && (hasStarted || hasProgress || stage !== 'queued')) {
                return 'processing';
            }
            if (!raw || raw === 'queued') {
                return 'pending';
            }
            return raw;
        }

        function getJobStageLabel(stage, status) {
            const labels = {
                queued: 'Aguardando',
                pending: 'Aguardando',
                processing: 'Iniciando',
                texto: 'Extraindo texto (PDF nativo)',
                ocr: 'Executando OCR',
                vision: 'Processando imagens',
                ia: 'Analisando com IA',
                final: 'Finalizando',
                merge: 'Consolidando dados',
                save: 'Salvando resultado'
            };
            return labels[stage] || (status === 'pending' ? 'Aguardando' : 'Processando');
        }

        function getJobProgress(job) {
            const total = Number(job.progress_total) || 0;
            const current = Number(job.progress_current) || 0;
            const percent = total > 0 ? Math.min(100, Math.round((current / total) * 100)) : 0;
            const displayStatus = getDisplayStatus(job);
            const stage = normalizeJobStage(job.progress_stage, displayStatus);
            const stageLabel = getJobStageLabel(stage, displayStatus);
            const message = job.progress_message || stageLabel;
            return { total, current, percent, stage, stageLabel, message, displayStatus };
        }

        function renderProgressBar(job) {
            const progress = getJobProgress(job);
            const displayStatus = progress.displayStatus;
            if (displayStatus === 'failed' || displayStatus === 'cancelled') {
                return '';
            }
            const indeterminate = progress.total <= 0 || progress.current <= 0;
            const width = indeterminate ? '40%' : `${progress.percent}%`;
            const statusClass = displayStatus === 'pending' ? 'pending' : 'processing';
            return `
                <div class="processing-progress ${statusClass} ${indeterminate ? 'indeterminate' : ''}">
                    <div class="processing-progress-bar" style="width: ${width};"></div>
                </div>
            `;
        }

        function getJobFileName(job) {
            if (job.original_filename) return job.original_filename;
            if (!job.file_path) return 'arquivo';
            const parts = job.file_path.split(/[\\/]/);
            return parts[parts.length - 1] || 'arquivo';
        }

        function formatJobError(job) {
            if (!job || !job.error) return '';
            const raw = String(job.error);
            const lines = raw.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
            if (!lines.length) return '';
            const errorLine = [...lines].reverse().find(line => /error|exception|falha/i.test(line))
                || lines[lines.length - 1];
            const cleaned = errorLine.replace(/^erro\s*:?\s*/i, '').trim();
            if (!cleaned) return '';
            return cleaned.length > 180 ? `${cleaned.slice(0, 177)}...` : cleaned;
        }

        function renderProcessingJobs() {
            const container = document.getElementById('processingJobs');
            if (!container) return;
            const jobs = Array.from(jobsEmProcessamento.values());
            if (jobs.length === 0) {
                container.innerHTML = '';
                return;
            }

            const queuedCount = jobs.filter(job => getDisplayStatus(job) === 'pending').length;
            const processingCount = jobs.filter(job => getDisplayStatus(job) === 'processing').length;
            const attentionCount = jobs.filter(job => {
                const status = getDisplayStatus(job);
                return status === 'failed' || status === 'cancelled';
            }).length;
            const summaryParts = [];
            if (queuedCount > 0) summaryParts.push(`${queuedCount} na fila`);
            if (processingCount > 0) summaryParts.push(`${processingCount} processando`);
            if (attentionCount > 0) summaryParts.push(`${attentionCount} com atencao`);
            const summaryText = summaryParts.join(' | ');

            const jobsHtml = jobs.map(job => {
                const displayStatus = getDisplayStatus(job);
                const statusLabel = getJobStatusLabel(displayStatus);
                const progress = getJobProgress(job);
                const progressText = progress.total > 0 ? `${progress.current}/${progress.total} (${progress.percent}%)` : '';
                const times = getJobTimes(job);

                // Mostrar tempo de fila apenas se ainda est√° na fila (pending)
                const queueTimeText = displayStatus === 'pending' && times.hasQueue
                    ? `Fila: ${formatarTempo(times.queueMs)}`
                    : '';

                // Mostrar tempo de processamento quando est√° processando
                const processingTimeText = displayStatus === 'processing'
                    ? `Tempo: ${formatarTempo(times.processingMs)}`
                    : '';

                // Pipeline detectado pelo stage
                const pipeline = getPipelineFromStage(progress.stage);
                const pipelineText = displayStatus === 'processing' && pipeline
                    ? `Pipeline: ${getPipelineLabel(pipeline)}`
                    : '';

                // Est√°gio atual
                const showStage = displayStatus === 'processing';
                const stageText = showStage ? progress.stageLabel : '';

                // Detalhe adicional (mensagem do progress)
                const detailText = displayStatus === 'processing' && progress.message && progress.message !== progress.stageLabel
                    ? progress.message
                    : '';

                const metaItems = [
                    queueTimeText ? `<span class="job-meta-item">‚è±Ô∏è ${queueTimeText}</span>` : '',
                    processingTimeText ? `<span class="job-meta-item">‚è±Ô∏è ${processingTimeText}</span>` : '',
                    pipelineText ? `<span class="job-meta-item">üìä ${pipelineText}</span>` : '',
                    stageText ? `<span class="job-meta-item">üîÑ ${stageText}</span>` : '',
                    progressText ? `<span class="job-meta-item">üìà ${progressText}</span>` : ''
                ].filter(Boolean).join('');
                const fileName = getJobFileName(job);
                const syncError = job.poll_error ? `<div class="processing-job-error">${job.poll_error}</div>` : '';
                const errorMessage = formatJobError(job);
                const errorHtml = displayStatus === 'failed' && errorMessage
                    ? `<div class="processing-job-error">${errorMessage}</div>`
                    : '';
                const actionHtml = displayStatus === 'failed' || displayStatus === 'cancelled'
                    ? `
                        <button class="btn btn-outline btn-sm" onclick="reprocessarJob('${job.id}')">Tentar novamente</button>
                        <button class="btn btn-outline btn-sm" onclick="excluirJob('${job.id}')">Remover</button>
                    `
                    : `<button class="btn btn-outline btn-sm" onclick="cancelarJob('${job.id}')">Cancelar</button>`;

                return `
                    <div class="processing-job ${displayStatus}">
                        <div class="processing-job-info">
                            <div class="processing-job-head">
                                <div class="processing-job-title" title="${fileName}">${fileName}</div>
                                <span class="job-status ${displayStatus}">${statusLabel}</span>
                            </div>
                            <div class="processing-job-meta">
                            ${metaItems}
                        </div>
                        ${renderProgressBar(job)}
                        ${syncError}
                        ${errorHtml}
                    </div>
                    <div class="processing-job-actions">
                        ${actionHtml}
                    </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="card">
                    <div class="processing-header">
                        <h2 class="processing-header-title">Processamento de atestados</h2>
                        ${summaryText ? `<p class="processing-header-subtitle">${summaryText}</p>` : ''}
                    </div>
                    ${jobsHtml}
                </div>
            `;
        }

        function upsertJob(job) {
            if (!job || !job.id) return;
            const existing = jobsEmProcessamento.get(job.id);
            const merged = existing ? { ...existing, ...job } : job;
            if (!merged.local_created_at) {
                merged.local_created_at = existing?.local_created_at || new Date().toISOString();
            }
            if (!merged.created_at) {
                merged.created_at = merged.local_created_at;
            }
            jobsEmProcessamento.set(job.id, merged);
            renderProcessingJobs();
        }

        function removeJob(jobId) {
            if (!jobsEmProcessamento.has(jobId)) return;
            jobsEmProcessamento.delete(jobId);
            renderProcessingJobs();
        }

        function dismissJob(jobId) {
            if (jobTimers.has(jobId)) {
                clearInterval(jobTimers.get(jobId));
                jobTimers.delete(jobId);
            }
            removeJob(jobId);
        }

        function markJobCompleted(job) {
            if (job?.file_path) {
                recentlyCompletedPaths.add(job.file_path);
                setTimeout(() => {
                    recentlyCompletedPaths.delete(job.file_path);
                    carregarAtestados();
                }, 8000);
            }
        }

        async function monitorarJob(jobId) {
            if (jobTimers.has(jobId)) return;
            const poll = async () => {
                try {
                    const data = await api.get(`/api/ai/queue/jobs/${jobId}`);
                    const job = data.job;
                    if (!job) return;
                    job.last_polled_at = new Date().toISOString();
                    job.poll_error = null;
                    if (job.status === 'completed') {
                        markJobCompleted(job);
                        removeJob(jobId);
                        clearInterval(jobTimers.get(jobId));
                        jobTimers.delete(jobId);
                        ui.showAlert('Atestado processado com sucesso!', 'success');
                        carregarAtestados();
                        return;
                    }
                    if (job.status === 'failed' || job.status === 'cancelled') {
                        upsertJob(job);
                        clearInterval(jobTimers.get(jobId));
                        jobTimers.delete(jobId);
                        if (!notifiedJobs.has(job.id)) {
                            const msg = job.status === 'cancelled'
                                ? 'Processamento cancelado.'
                                : (formatJobError(job) || 'Falha no processamento do atestado');
                            ui.showAlert(msg, job.status === 'cancelled' ? 'warning' : 'error');
                            notifiedJobs.add(job.id);
                        }
                        return;
                    }
                    upsertJob(job);
                } catch (error) {
                    console.error('Erro ao consultar job:', error);
                    const existing = jobsEmProcessamento.get(jobId);
                    if (existing) {
                        upsertJob({
                            id: jobId,
                            poll_error: 'Falha ao atualizar status. Verifique sua conexao.',
                            last_polled_at: new Date().toISOString()
                        });
                    }
                }
            };
            jobTimers.set(jobId, setInterval(poll, 3000));
            await poll();
        }

        async function carregarJobsEmProcessamento() {
            try {
                const data = await api.get('/api/ai/queue/jobs?limit=20');
                const jobs = (data.jobs || []).filter(j => j.job_type === 'atestado' && j.status !== 'completed');
                jobs.forEach(job => {
                    job.last_polled_at = new Date().toISOString();
                    job.poll_error = null;
                    upsertJob(job);
                    if (job.status === 'pending' || job.status === 'processing') {
                        monitorarJob(job.id);
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar jobs:', error);
                ui.showAlert('Falha ao sincronizar o processamento. Tentando novamente...', 'warning');
            }
        }

        async function cancelarJob(jobId) {
            if (!confirm('Cancelar o processamento deste atestado?')) return;
            try {
                const data = await api.post(`/api/ai/queue/jobs/${jobId}/cancel`, {});
                if (data.job) {
                    upsertJob(data.job);
                }
                ui.showAlert('Processamento cancelado.', 'warning');
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao cancelar processamento', 'error');
            }
        }

        async function reprocessarJob(jobId) {
            try {
                const data = await api.post(`/api/ai/queue/jobs/${jobId}/retry`, {});
                if (data.job) {
                    removeJob(jobId);
                    upsertJob(data.job);
                    monitorarJob(data.job.id);
                }
                ui.showAlert('Reprocessamento iniciado.', 'info');
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao reprocessar', 'error');
            }
        }

        async function excluirJob(jobId) {
            if (!confirm('Remover este job da lista?')) return;
            try {
                const data = await api.delete(`/api/ai/queue/jobs/${jobId}`);
                if (data.deleted) {
                    removeJob(jobId);
                }
                ui.showAlert('Job removido da lista.', 'success');
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao remover job', 'error');
            }
        }

        function startJobsRefresh() {
            if (refreshJobsInterval) return;
            refreshJobsInterval = setInterval(() => {
                const hasActiveJobs = Array.from(jobsEmProcessamento.values())
                    .some(job => job.status === 'pending' || job.status === 'processing');
                if (hasActiveJobs) {
                    carregarJobsEmProcessamento();
                }
            }, 10000);
        }

        function startJobsRenderer() {
            if (jobsRenderInterval) return;
            jobsRenderInterval = setInterval(() => {
                if (jobsEmProcessamento.size > 0) {
                    renderProcessingJobs();
                }
            }, 1000);
        }

        async function carregarAtestados() {
            try {
                const atestados = await api.get('/atestados/');
                atestadosCache = atestados;
                const container = document.getElementById('listaAtestados');
                const btnRelatorioGeral = document.getElementById('btnRelatorioGeral');

                // Mostrar bot√£o de relat√≥rio geral se houver atestados
                btnRelatorioGeral.style.display = atestados.length > 0 ? 'inline-block' : 'none';

                const hasActiveJobs = Array.from(jobsEmProcessamento.values())
                    .some(job => job.status === 'pending' || job.status === 'processing');

                if (atestados.length === 0) {
                    const emptyTitle = hasActiveJobs
                        ? 'Nenhum atestado conclu√≠do ainda'
                        : 'Nenhum atestado cadastrado';
                    const emptyText = hasActiveJobs
                        ? 'Seus arquivos est√£o em processamento e aparecer√£o aqui ao concluir.'
                        : 'Cadastre seu primeiro atestado de capacidade t√©cnica';
                    container.innerHTML = `
                        <div class="card empty-state">
                            <div class="empty-state-icon">&#128203;</div>
                            <h3>${emptyTitle}</h3>
                            <p class="text-muted">${emptyText}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = atestados.map(a => `
                    <div class="card ${recentlyCompletedPaths.has(a.arquivo_path) ? 'atestado-highlight' : ''}">
                        <div class="atestado-card">
                            <div class="atestado-info">
                                <h3>${a.descricao_servico || 'Atestado de Capacidade Tecnica'}</h3>
                                ${a.contratante ? `<p class="text-muted">Contratante: ${a.contratante}</p>` : ''}
                                ${a.data_emissao ? `<p class="text-muted">Emitido em: ${formatarDataSemHora(a.data_emissao)}</p>` : ''}
                                ${a.servicos_json && a.servicos_json.length > 0 ?
                                    `<span class="badge">${a.servicos_json.length} servico(s) identificado(s)</span>` :
                                    '<span class="badge badge-secondary">Sem servicos detalhados</span>'
                                }
                            </div>
                            <div class="atestado-actions">
                                <button class="btn btn-primary btn-sm" onclick="verResultadoConsolidado(${a.id})">Resultado Consolidado</button>
                                <button class="btn btn-outline btn-sm" onclick="editarAtestado(${a.id})">Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="excluirAtestado(${a.id})">Excluir</button>
                            </div>
                        </div>
                        ${renderizarServicosPreview(a)}
                    </div>
                `).join('');

            } catch (error) {
                ui.showAlert('Erro ao carregar atestados', 'error');
            }
        }

        // Formata data sem hor√°rio
        function formatarDataSemHora(dataStr) {
            if (!dataStr) return '';
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR');
        }

        function setupUpload() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('fileInput');

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) uploadFile(file);
            });

            input.addEventListener('change', () => {
                if (input.files[0]) {
                    uploadFile(input.files[0]);
                    input.value = '';
                }
            });
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                ui.showAlert('Enviando arquivo...', 'info');
                const result = await api.upload('/atestados/upload', formData);
                ui.showAlert(result.mensagem || 'Arquivo enviado. Processamento iniciado.', 'info');
                if (result.job_id) {
                    upsertJob({
                        id: result.job_id,
                        status: 'pending',
                        job_type: 'atestado',
                        created_at: new Date().toISOString(),
                        original_filename: file.name,
                        local_created_at: new Date().toISOString()
                    });
                    monitorarJob(result.job_id);
                }
                await carregarJobsEmProcessamento();
                carregarAtestados();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao enviar arquivo', 'error');
            }
        }

        function setupFormAtestado() {
            document.getElementById('formAtestado').addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = document.getElementById('atId').value;
                const dados = {
                    descricao_servico: document.getElementById('atDescricao').value,
                    quantidade: parseFloat(document.getElementById('atQuantidade').value),
                    unidade: document.getElementById('atUnidade').value,
                    contratante: document.getElementById('atContratante').value || null,
                    data_emissao: document.getElementById('atDataEmissao').value || null
                };

                try {
                    if (id) {
                        await api.put(`/atestados/${id}`, dados);
                        ui.showAlert('Atestado atualizado com sucesso!', 'success');
                    } else {
                        await api.post('/atestados/', dados);
                        ui.showAlert('Atestado cadastrado com sucesso!', 'success');
                    }
                    fecharModal('modalAtestado');
                    carregarAtestados();
                } catch (error) {
                    ui.showAlert(error.message || 'Erro ao salvar atestado', 'error');
                }
            });
        }

        function abrirModalAtestado() {
            document.getElementById('modalAtestadoTitle').textContent = 'Cadastrar Atestado';
            document.getElementById('formAtestado').reset();
            document.getElementById('atId').value = '';
            document.getElementById('modalAtestado').classList.add('active');
        }

        async function editarAtestado(id) {
            try {
                const atestado = await api.get(`/atestados/${id}`);
                document.getElementById('modalAtestadoTitle').textContent = 'Editar Atestado';
                document.getElementById('atId').value = atestado.id;
                document.getElementById('atDescricao').value = atestado.descricao_servico || '';
                document.getElementById('atQuantidade').value = atestado.quantidade || '';
                document.getElementById('atUnidade').value = atestado.unidade || '';
                document.getElementById('atContratante').value = atestado.contratante || '';
                document.getElementById('atDataEmissao').value = atestado.data_emissao ? atestado.data_emissao.split('T')[0] : '';
                document.getElementById('modalAtestado').classList.add('active');
            } catch (error) {
                ui.showAlert('Erro ao carregar atestado', 'error');
            }
        }

        async function excluirAtestado(id) {
            if (!confirm('Tem certeza que deseja excluir este atestado?')) return;

            try {
                await api.delete(`/atestados/${id}`);
                ui.showAlert('Atestado excluido com sucesso!', 'success');
                carregarAtestados();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao excluir atestado', 'error');
            }
        }

        // Exclui um item de servi√ßo espec√≠fico do atestado
        async function excluirServicoItem(atestadoId, itemIndex) {
            if (!confirm('Excluir este item de servico?')) return;

            try {
                // Buscar atestado atual
                const atestado = await api.get(`/atestados/${atestadoId}`);

                if (!atestado.servicos_json || itemIndex >= atestado.servicos_json.length) {
                    ui.showAlert('Item nao encontrado', 'error');
                    return;
                }

                // Remover item do array
                const novosServicos = [...atestado.servicos_json];
                novosServicos.splice(itemIndex, 1);

                // Atualizar atestado via PATCH
                await api.patch(`/atestados/${atestadoId}/servicos`, {
                    servicos_json: novosServicos
                });

                ui.showAlert('Item excluido com sucesso!', 'success');
                carregarAtestados();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao excluir item', 'error');
            }
        }

        // Abre modal para editar um item de servi√ßo
        async function editarServicoItem(atestadoId, itemIndex) {
            try {
                const atestado = await api.get(`/atestados/${atestadoId}`);

                if (!atestado.servicos_json || itemIndex >= atestado.servicos_json.length) {
                    ui.showAlert('Item nao encontrado', 'error');
                    return;
                }

                const servico = atestado.servicos_json[itemIndex];
                const parsed = extrairItemDescricao(servico);

                // Preencher formul√°rio
                document.getElementById('editServicoAtestadoId').value = atestadoId;
                document.getElementById('editServicoIndex').value = itemIndex;
                document.getElementById('editServicoItem').value = servico.item || parsed.item || '';
                document.getElementById('editServicoDescricao').value = parsed.descricao || '';
                document.getElementById('editServicoQuantidade').value = servico.quantidade || '';
                document.getElementById('editServicoUnidade').value = servico.unidade || '';

                // Abrir modal
                document.getElementById('modalEditarServico').classList.add('active');
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao carregar item', 'error');
            }
        }

        // Salva as altera√ß√µes do item de servi√ßo
        async function salvarServicoItem(event) {
            event.preventDefault();

            const atestadoId = document.getElementById('editServicoAtestadoId').value;
            const itemIndex = parseInt(document.getElementById('editServicoIndex').value);
            const item = document.getElementById('editServicoItem').value.trim();
            const descricao = document.getElementById('editServicoDescricao').value.trim();
            const quantidade = parseFloat(document.getElementById('editServicoQuantidade').value);
            const unidade = document.getElementById('editServicoUnidade').value.trim();

            if (!descricao || isNaN(quantidade) || !unidade) {
                ui.showAlert('Preencha todos os campos obrigatorios', 'error');
                return;
            }

            try {
                const atestado = await api.get(`/atestados/${atestadoId}`);

                if (!atestado.servicos_json || itemIndex >= atestado.servicos_json.length) {
                    ui.showAlert('Item nao encontrado', 'error');
                    return;
                }

                // Atualizar item no array
                const novosServicos = [...atestado.servicos_json];
                novosServicos[itemIndex] = {
                    item: item || null,
                    descricao: descricao,
                    quantidade: quantidade,
                    unidade: unidade
                };

                // Atualizar atestado via PATCH
                await api.patch(`/atestados/${atestadoId}/servicos`, {
                    servicos_json: novosServicos
                });

                fecharModal('modalEditarServico');
                ui.showAlert('Item atualizado com sucesso!', 'success');
                carregarAtestados();
            } catch (error) {
                ui.showAlert(error.message || 'Erro ao salvar item', 'error');
            }
        }

        // Renderiza lista completa de servi√ßos com chevron expans√≠vel
        function renderizarServicosPreview(atestado) {
            if (!atestado.servicos_json || atestado.servicos_json.length === 0) {
                return '';
            }

            const servicosHtml = atestado.servicos_json.map((s, index) => {
                const parsed = extrairItemDescricao(s);
                const itemHtml = parsed.item ? `<span class="servico-item-codigo">${parsed.item}</span>` : '';
                return `
                    <div class="servico-item" data-index="${index}">
                        <span class="servico-descricao">${itemHtml}${parsed.descricao}</span>
                        <span class="servico-quantidade">${formatarNumero(s.quantidade)} ${s.unidade}</span>
                        <div class="servico-actions">
                            <button class="servico-btn edit" onclick="editarServicoItem(${atestado.id}, ${index})" title="Editar item">&#9998;</button>
                            <button class="servico-btn delete" onclick="excluirServicoItem(${atestado.id}, ${index})" title="Excluir item">&#10005;</button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="margin-top: var(--spacing-md);">
                    <button class="servicos-toggle" onclick="toggleServicos(this)">
                        <span class="chevron">&#9654;</span>
                        Ver detalhes (${atestado.servicos_json.length} servico(s))
                    </button>
                    <div class="servicos-lista">
                        ${servicosHtml}
                    </div>
                </div>
            `;
        }

        // Toggle para expandir/recolher lista de servi√ßos
        function toggleServicos(btn) {
            const lista = btn.nextElementSibling;
            const chevron = btn.querySelector('.chevron');

            lista.classList.toggle('active');
            chevron.innerHTML = lista.classList.contains('active') ? '&#9660;' : '&#9654;';
        }

        // Abre modal com resultado consolidado do atestado
        async function verResultadoConsolidado(id) {
            try {
                const atestado = await api.get(`/atestados/${id}`);
                const content = document.getElementById('resultadoContent');

                content.innerHTML = gerarRelatorioAtestado(atestado);
                document.getElementById('modalResultado').classList.add('active');
            } catch (error) {
                ui.showAlert('Erro ao carregar resultado', 'error');
            }
        }

        // Extrai item e descricao (compatibilidade com dados antigos)
        function extrairItemDescricao(servico) {
            const descricaoOriginal = (servico?.descricao || '').toString();
            if (servico?.item) {
                return { item: servico.item, descricao: descricaoOriginal };
            }
        
            const itemRegex = /^(\d{1,3}(?:\s*\.\s*\d{1,3}){1,3}|\d{1,3}(?:\s+\d{1,2}){1,3})\s*/;
            const match = descricaoOriginal.match(itemRegex);
            if (!match) {
                return { item: null, descricao: descricaoOriginal };
            }
        
            const item = match[1]
                .replace(/\s+/g, '.')
                .replace(/\.+/g, '.')
                .replace(/^\.+|\.+$/g, '');
            const descricao = descricaoOriginal.replace(itemRegex, '').trim();
            return { item, descricao: descricao || descricaoOriginal };
        }

        function normalizarUnidade(unidade) {
            return (unidade || '')
                .toString()
                .toUpperCase()
                .replace(/\u00b2/g, '2')
                .replace(/\u00b3/g, '3')
                .replace('M^2', 'M2')
                .replace('M^3', 'M3')
                .replace(/\s+/g, '');
        }
        
        // Remove codigo do item (ex: "001.03.11" -> "")
        function removerCodigoItem(descricao) {
            // Padr√£o: 3 d√≠gitos + separador + 2 d√≠gitos + separador + 2 d√≠gitos + espa√ßo
            // Ex: "001.03.11 PORT√ÉO..." -> "PORT√ÉO..."
            return descricao.replace(/^(\d{1,3}(?:\s*\.\s*\d{1,3}){1,3}|\d{1,3}(?:\s+\d{1,2}){1,3})\s*/, '').trim();
        }

        // Agrupa servi√ßos por descri√ß√£o (sem c√≥digo) e soma quantidades
        function agruparServicosPorDescricao(servicos) {
            const agrupados = {};
            servicos.forEach(s => {
                const parsed = extrairItemDescricao(s);
                const unidade = normalizarUnidade(s.unidade);
                const chave = `${parsed.descricao.toUpperCase()}|||${unidade}`;
                if (!agrupados[chave]) {
                    agrupados[chave] = {
                        descricao: parsed.descricao,
                        unidade: unidade,
                        quantidade: 0
                    };
                }
                agrupados[chave].quantidade += parseFloat(s.quantidade) || 0;
            });
            // Ordenar por descri√ß√£o
            return Object.values(agrupados).sort((a, b) => a.descricao.localeCompare(b.descricao));
        }

        // Gera HTML do relat√≥rio de um atestado
        function gerarRelatorioAtestado(atestado) {
            const servicos = atestado.servicos_json || [];
            const servicosConsolidados = agruparServicosPorDescricao(servicos);

            return `
                <div class="relatorio-header">
                    <h3>${atestado.descricao_servico || 'Atestado de Capacidade Tecnica'}</h3>
                    <div class="relatorio-info">
                        ${atestado.contratante ? `
                            <div class="relatorio-info-item">
                                <span class="relatorio-info-label">Contratante</span>
                                <span class="relatorio-info-value">${atestado.contratante}</span>
                            </div>
                        ` : ''}
                        ${atestado.data_emissao ? `
                            <div class="relatorio-info-item">
                                <span class="relatorio-info-label">Data de Emissao</span>
                                <span class="relatorio-info-value">${formatarDataSemHora(atestado.data_emissao)}</span>
                            </div>
                        ` : ''}
                        <div class="relatorio-info-item">
                            <span class="relatorio-info-label">Itens Originais</span>
                            <span class="relatorio-info-value">${servicos.length}</span>
                        </div>
                        <div class="relatorio-info-item">
                            <span class="relatorio-info-label">Itens Consolidados</span>
                            <span class="relatorio-info-value">${servicosConsolidados.length}</span>
                        </div>
                    </div>
                </div>

                <div class="relatorio-section">
                    <h4 class="relatorio-section-title">Servicos Consolidados (agrupados por descricao)</h4>
                    ${servicosConsolidados.length > 0 ? `
                        <table class="relatorio-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th>Descricao do Servico</th>
                                    <th style="width: 80px;">Unidade</th>
                                    <th style="width: 120px;">Quantidade Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicosConsolidados.map((s, i) => `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${s.descricao}</td>
                                        <td>${s.unidade}</td>
                                        <td class="numero">${formatarNumero(s.quantidade)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p class="text-muted">Nenhum servico detalhado foi extraido deste documento.</p>'}
                </div>

            `;
        }

        // Abre relat√≥rio geral de todos os atestados
        function abrirRelatorioGeral() {
            const content = document.getElementById('relatorioGeralContent');
            content.innerHTML = gerarRelatorioGeral(atestadosCache);
            document.getElementById('modalRelatorioGeral').classList.add('active');
        }

        // Gera HTML do relat√≥rio geral
        function gerarRelatorioGeral(atestados) {
            // Contar total de servi√ßos e consolidar
            let totalServicos = 0;
            let todosServicos = [];
            atestados.forEach(a => {
                if (a.servicos_json && a.servicos_json.length > 0) {
                    totalServicos += a.servicos_json.length;
                    todosServicos = todosServicos.concat(a.servicos_json);
                }
            });

            const servicosConsolidadosGeral = agruparServicosPorDescricao(todosServicos);

            return `
                <div class="relatorio-header">
                    <h3>Consolidado de Todos os Atestados</h3>
                    <div class="relatorio-info">
                        <div class="relatorio-info-item">
                            <span class="relatorio-info-label">Total de Atestados</span>
                            <span class="relatorio-info-value">${atestados.length}</span>
                        </div>
                        <div class="relatorio-info-item">
                            <span class="relatorio-info-label">Itens Originais</span>
                            <span class="relatorio-info-value">${totalServicos}</span>
                        </div>
                        <div class="relatorio-info-item">
                            <span class="relatorio-info-label">Itens Consolidados</span>
                            <span class="relatorio-info-value">${servicosConsolidadosGeral.length}</span>
                        </div>
                    </div>
                </div>

                <div class="relatorio-section">
                    <h4 class="relatorio-section-title">Servicos Consolidados de Todos os Atestados</h4>
                    ${servicosConsolidadosGeral.length > 0 ? `
                        <table class="relatorio-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th>Descricao do Servico</th>
                                    <th style="width: 80px;">Unidade</th>
                                    <th style="width: 120px;">Quantidade Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicosConsolidadosGeral.map((s, i) => `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${s.descricao}</td>
                                        <td>${s.unidade}</td>
                                        <td class="numero">${formatarNumero(s.quantidade)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p class="text-muted">Nenhum servico encontrado.</p>'}
                </div>

            `;
        }

    </script>
</body>
</html>
